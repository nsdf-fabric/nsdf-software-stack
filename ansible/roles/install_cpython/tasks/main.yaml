

---
  

# ////////////////////////////////////////////////
- name: Setup OS
  become: yes
  args:
    creates: ~/.ansible.setup_os.done
    executable: /bin/bash
  shell: |
    # stop on errors
    set -e
    
    # Redirect standard error to standard out
    exec 2>&1

    # enable ssh password authentication just in case
    sed -i "/^[^#]*PasswordAuthentication[[:space:]]no/c\PasswordAuthentication yes" /etc/ssh/sshd_config

    # allow TCP forwarding (needed for vscode)
    sed -i "s/^#AllowTcpForwarding yes/AllowTcpForwarding yes/g" /etc/ssh/sshd_config

    systemctl restart ssh.service
     
    # disable firewall just in case
    ufw disable || true

    # solve a problem with nvidia drivers
    apt-key del 7fa2af80 || true
    apt-key adv --fetch-keys https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2004/$(uname -m)/3bf863cc.pub || true

    apt update

    # very minimal packages
    apt install -y curl git wget vim nano cmake swig less bzip2 zip unzip pkg-config  sshpass awscli pigz

    # setup number of connections
    aws configure set default.s3.max_concurrent_requests 64

    # install s5cmd
    curl -L https://github.com/peak/s5cmd/releases/download/v2.0.0/s5cmd_2.0.0_Linux-64bit.tar.gz | sudo tar xz -C /usr/bin

    # to produce diagrams
    apt-get install -y graphviz

    # install cpython
    apt install -y python3 python3-pip
    python3 -m pip install --upgrade pip

    touch ~/.ansible.setup_os.done


# ////////////////////////////////////////////////
- name: Copy id_nsda to id_rsa 
  become: no
  copy:
    src: "{{ansible_ssh_private_key_file}}"
    dest: "~/.ssh/id_rsa"
    mode: '0700'

# ////////////////////////////////////////////////
- name: Install cpython wheels
  become: no
  pip:
    extra_args: --user
    name: 
      - pyyaml 
      - requests 
      - urllib3 
      - asyncssh 
      - pendulum
      - cryptography
      - awscli 
      - boto3
      - distributed
      - dask[complete] 
      - prefect[viz]  
      - BeautifulSoup4
      - imageio
      - OpenVisusNoGui
      - scikit-image
      - numpy
      - scipy
      - matplotlib 
      # in general these are not needed
      # - pandas
      # - s3fs
      # - python-chi               (this is needed for nsdf-cloudChameleon CLoud)
      # - vultr                    (this is needed for nsdf-cloud/vultr)
      # - materials-commons-api    (this is needed for nsdf-catalog)
      # - mysql-connector-python   (this is needed for nsdf-catalog)  
      # - mdf_forge                (this is needed for nsdf-catalog)


# ////////////////////////////////////////////////
- name: Fix python wheels
  become: yes
  args:
    executable: /bin/bash
    creates: ~/.ansible.fix-python.done
  shell: |
    python3 -m pip install --upgrade urllib3 requests awscli
    python3 -m pip install --upgrade cryptography
    python3 -m pip install --upgrade ansible
    python3 -m pip install --upgrade awscli
    touch ~/.ansible.fix-python.done

# ////////////////////////////////////////////////
- name: Copy bashrc.conf
  become: no
  copy:
    src: "bashrc.conf"
    dest: "~/bashrc.conf"
    mode: '0700'

- name: Source bashrc.conf
  become: no
  args:
    executable: /bin/bash
    creates: ~/.ansible.source-bashrc.done
  shell: |
    echo 'source ~/bashrc.conf' >> ~/.bashrc 
    touch ~/.ansible.source-bashrc.done

# ////////////////////////////////////////////////
- name: Final setup
  become: no
  args:
    executable: /bin/bash
    creates: ~/.ansible.final-setup.done
  shell: |
    # stop on errors
    set -e 

    # Redirect standard error to standard out
    exec 2>&1 

    # setup git credentials *change as needed (TODO: make it better with variables)
    git config --global user.name "Giorgio Scorzelli"
    git config --global user.email "scrgiorgio@gmail.com"

    export GIT_SSH_COMMAND="ssh -o 'StrictHostKeyChecking=no' -i ~/.ssh/id_rsa" 

    # vault
    rm -Rf ~/.nsdf/vault
    git clone git@github.com:nsdf-fabric/vault.git ~/.nsdf/vault
    mkdir -p ~/.aws/
    cp ~/.nsdf/vault/aws/*      ~/.aws/

    # software stack    
    rm -Rf ~/nsdf-software-stack
    git clone git@github.com:nsdf-fabric/nsdf-software-stack.git ~/nsdf-software-stack

    touch ~/.ansible.final-setup.done
